
<!DOCTYPE html>

<html>
  <head>
   <!-- Global site tag (gtag.js) - Google Analytics -->
   <script async src="https://www.googletagmanager.com/gtag/js?id=G-QHB6CBHE8P"></script>
   <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QHB6CBHE8P');
   </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rolling returns &#8212; LeDataSciFi-2025</title>
    
  <link rel="stylesheet" href="../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/moviescript.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/fin377_specialformatting.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/frontpage.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script >const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">LeDataSciFi-2025</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <p class="caption collapsible-parent">
 <span class="caption-text">
  Syllabus
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../about/objectives.html">
   Objectives
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about/outcomes.html">
   Outcomes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about/about_us.html">
   About us + office hours
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about/structure_and_policies.html">
   Course structure + policies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about/use_of_gpt.html">
   ChatGPT and other AI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about/gradeoverview.html">
   Grading
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about/interest.html">
   Interested but unsure?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about/bootcamp.html">
   Pre-Class Bootcamp
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about/hall_of_awesomeness.html">
   The Hall of Awesomeness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../about/acknowledgments.html">
   Gratitude
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/content/05/05a_rolling.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/LeDataSciFi/ledatascifi-2025"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/LeDataSciFi/ledatascifi-2025/issues/new?title=Issue%20on%20page%20%2Fcontent/05/05a_rolling.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/LeDataSciFi/ledatascifi-2025/edit/main/content/05/05a_rolling.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/LeDataSciFi/ledatascifi-2025/main?urlpath=lab/tree/content/05/05a_rolling.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/LeDataSciFi/ledatascifi-2025/blob/main/content/05/05a_rolling.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-problem">
   The problem
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#working-the-problem">
   Working the problem
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-solution">
   The solution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-answer">
   The answer
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="rolling-returns">
<h1>Rolling returns<a class="headerlink" href="#rolling-returns" title="Permalink to this headline">¶</a></h1>
<div class="note admonition">
<p class="admonition-title">Takeaway</p>
<p>When you want rolling returns over some calendar unit (hours, days, weeks, months, year), in realistic data with many firms and returns missing for parts of the calendar (e.g. no weekend trading, no after-hours trading):</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">df['newVarName']</span> <span class="pre">=</span> <span class="pre">df.set_index('date').groupby('asset')['ret'].rolling(window=&lt;dateoffset&gt;,1).apply(lambda</span> <span class="pre">x:</span> <span class="pre">np.prod(1+x)-1).values</span></code></p></li>
<li><p>Do not use <code class="docutils literal notranslate"><span class="pre">window=#</span></code> unless you are sure your data is perfectly formed. <code class="docutils literal notranslate"><span class="pre">window=5</span></code> fails in real data because stock markets close for the weekend.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">&lt;dateoffset&gt;</span></code> could be ‘7D’, ‘24H’, ‘1M’ or many other things - <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#offset-aliases">see this link</a>.</p></li>
<li><p>The docs for the <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.rolling.html#pandas.DataFrame.rolling"><code class="docutils literal notranslate"><span class="pre">rolling</span></code> function</a> provide extra functionality.</p></li>
</ol>
</div>
<p>Suppose we have an asset-timeperiod dataset, in long/tidy form. For example, this is a firm-day trading dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Firm&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
                  <span class="s1">&#39;Date&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;1/11/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/12/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/13/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/14/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/18/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/19/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/30/22&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;1/11/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/12/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/13/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/14/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/18/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/19/22&#39;</span><span class="p">,</span><span class="s1">&#39;1/30/22&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;ret&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mf">.01</span><span class="p">,</span><span class="mf">.01</span><span class="p">,</span><span class="mf">.01</span><span class="p">,</span><span class="o">-</span><span class="mf">.0294</span><span class="p">,</span><span class="mf">.01</span><span class="p">,</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">.03</span><span class="p">,</span><span class="mf">.02</span><span class="p">,</span><span class="o">-</span><span class="mf">.02</span><span class="p">,</span><span class="mf">.03</span><span class="p">,</span><span class="o">-</span><span class="mf">.03</span><span class="p">,</span><span class="mf">.04</span><span class="p">,</span><span class="o">-</span><span class="mf">.04</span><span class="p">,</span><span class="mf">.05</span><span class="p">]</span> <span class="p">})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Date</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%y&quot;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Firm</th>
      <th>Date</th>
      <th>ret</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2022-01-11</td>
      <td>0.0100</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2022-01-12</td>
      <td>0.0100</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2022-01-13</td>
      <td>0.0100</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>2022-01-14</td>
      <td>-0.0294</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>2022-01-18</td>
      <td>0.0100</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>2022-01-19</td>
      <td>-0.0100</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>2022-01-30</td>
      <td>0.0300</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2</td>
      <td>2022-01-11</td>
      <td>0.0200</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2</td>
      <td>2022-01-12</td>
      <td>-0.0200</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2</td>
      <td>2022-01-13</td>
      <td>0.0300</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2</td>
      <td>2022-01-14</td>
      <td>-0.0300</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2</td>
      <td>2022-01-18</td>
      <td>0.0400</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2</td>
      <td>2022-01-19</td>
      <td>-0.0400</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2</td>
      <td>2022-01-30</td>
      <td>0.0500</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="section" id="the-problem">
<h2>The problem<a class="headerlink" href="#the-problem" title="Permalink to this headline">¶</a></h2>
<p>Let’s create a variable containing the cumulative return over the last week. Let’s stipulate that if we have less than five days of returns for a firm at any point, we just use what we have.</p>
</div>
<div class="section" id="working-the-problem">
<h2>Working the problem<a class="headerlink" href="#working-the-problem" title="Permalink to this headline">¶</a></h2>
<p>This one-liner is very close to correct:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Firm&#39;</span><span class="p">)[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>It’s not correct, but let’s start here because it’s easier to understand. Let me separate that code up and add comments for each part:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Firm&#39;</span><span class="p">)[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span>         <span class="c1"># for each firm, grab the ret var</span>
 <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># in each row, use the prior 1-5 obs (including the current one)</span>
 <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># R[0,T] = prod{ R(0), ..., R(T) } - 1</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To add that variable to our dataset, <code class="docutils literal notranslate"><span class="pre">df['varname']</span> <span class="pre">=</span> <span class="pre">&lt;the</span> <span class="pre">above&gt;</span></code> doesn’t quite work. A small workaround does it: add <code class="docutils literal notranslate"><span class="pre">.values</span></code> to the end of the line. (<em>It returns just the column of numbers and ignores the weird index the code above makes.</em>)</p>
<p>So let’s look at the result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ret1week_wrong&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Firm&#39;</span><span class="p">)[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">df</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="c1"># just look at the top of the dataset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Firm</th>
      <th>Date</th>
      <th>ret</th>
      <th>ret1week_wrong</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2022-01-11</td>
      <td>0.0100</td>
      <td>0.010000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2022-01-12</td>
      <td>0.0100</td>
      <td>0.020100</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2022-01-13</td>
      <td>0.0100</td>
      <td>0.030301</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>2022-01-14</td>
      <td>-0.0294</td>
      <td>0.000010</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>2022-01-18</td>
      <td>0.0100</td>
      <td>0.010010</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>2022-01-19</td>
      <td>-0.0100</td>
      <td>-0.009990</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>2022-01-30</td>
      <td>0.0300</td>
      <td>0.009614</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The result above is wrong!</p>
<ul class="simple">
<li><p>1/17 was a holiday, so the return for 1/18 should start with 1/12 (and only use 4 rows).</p></li>
<li><p>1/30 should only include itself since we are missing dates.</p></li>
</ul>
</div>
<p>Let’s fix that. The <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.rolling.html#pandas.DataFrame.rolling">documentation</a> mentions that the window length can use a time period!</p>
<p>So instead of <code class="docutils literal notranslate"><span class="pre">window=5</span></code>, we can use <code class="docutils literal notranslate"><span class="pre">window='7D'</span></code>!</p>
<p>Except there is a final complication: After <code class="docutils literal notranslate"><span class="pre">df.groupby('Firm')['ret']</span></code>, the date variable is gone. And <code class="docutils literal notranslate"><span class="pre">rolling()</span></code> needs that, So we need to keep the date variable around somehow.</p>
<p>The last fix: Add <code class="docutils literal notranslate"><span class="pre">.set_index('Date')</span></code> before groupby, so that the date variable will stick around as the index.</p>
</div>
<div class="section" id="the-solution">
<h2>The solution<a class="headerlink" href="#the-solution" title="Permalink to this headline">¶</a></h2>
<p>Put all that together:</p>
<ol class="simple">
<li><p>Put the date in the index</p></li>
<li><p>“For each asset”</p></li>
<li><p>Grab the returns for the prior week (using the dates to allow for holidays)</p></li>
<li><p>Cumulate the returns</p></li>
<li><p>Add that variable to the dataset</p></li>
</ol>
<p>We can write this in one line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ret1week&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Firm&#39;</span><span class="p">)[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s1">&#39;7D&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-answer">
<h2>The answer<a class="headerlink" href="#the-answer" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Look at the last three dates for each firm, and you’ll see how incorrect the <code class="docutils literal notranslate"><span class="pre">window=#</span></code> approach is.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Firm&#39;</span><span class="p">,</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>ret</th>
      <th>ret1week_wrong</th>
      <th>ret1week</th>
    </tr>
    <tr>
      <th>Firm</th>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="7" valign="top">1</th>
      <th>2022-01-11</th>
      <td>0.0100</td>
      <td>0.010000</td>
      <td>0.010000</td>
    </tr>
    <tr>
      <th>2022-01-12</th>
      <td>0.0100</td>
      <td>0.020100</td>
      <td>0.020100</td>
    </tr>
    <tr>
      <th>2022-01-13</th>
      <td>0.0100</td>
      <td>0.030301</td>
      <td>0.030301</td>
    </tr>
    <tr>
      <th>2022-01-14</th>
      <td>-0.0294</td>
      <td>0.000010</td>
      <td>0.000010</td>
    </tr>
    <tr>
      <th>2022-01-18</th>
      <td>0.0100</td>
      <td>0.010010</td>
      <td>0.000010</td>
    </tr>
    <tr>
      <th>2022-01-19</th>
      <td>-0.0100</td>
      <td>-0.009990</td>
      <td>-0.019792</td>
    </tr>
    <tr>
      <th>2022-01-30</th>
      <td>0.0300</td>
      <td>0.009614</td>
      <td>0.030000</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">2</th>
      <th>2022-01-11</th>
      <td>0.0200</td>
      <td>0.020000</td>
      <td>0.020000</td>
    </tr>
    <tr>
      <th>2022-01-12</th>
      <td>-0.0200</td>
      <td>-0.000400</td>
      <td>-0.000400</td>
    </tr>
    <tr>
      <th>2022-01-13</th>
      <td>0.0300</td>
      <td>0.029588</td>
      <td>0.029588</td>
    </tr>
    <tr>
      <th>2022-01-14</th>
      <td>-0.0300</td>
      <td>-0.001300</td>
      <td>-0.001300</td>
    </tr>
    <tr>
      <th>2022-01-18</th>
      <td>0.0400</td>
      <td>0.038648</td>
      <td>0.018283</td>
    </tr>
    <tr>
      <th>2022-01-19</th>
      <td>-0.0400</td>
      <td>-0.022449</td>
      <td>-0.002499</td>
    </tr>
    <tr>
      <th>2022-01-30</th>
      <td>0.0500</td>
      <td>0.047377</td>
      <td>0.050000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content/05"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Prof. Donald Bowen<br/>
        
            &copy; Copyright 2025.<br/>
          <div class="extra_footer">
            You're doing well, keep going!
          </div>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>